<!DOCTYPE html><html><head><link rel="preload" href="/_next/def0ce2c-a931-474c-9741-365499518ee9/page/post/index.js" as="script"/><link rel="preload" href="/_next/def0ce2c-a931-474c-9741-365499518ee9/page/_error/index.js" as="script"/><link rel="preload" href="/_next/33a7e45548f8fb8000dd8f014de5fbfb/app.js" as="script"/><meta charset="utf-8" class="next-head"/><meta name="viewport" content="width=device-width, initial-scale=1" class="next-head"/><meta name="theme-color" content="#000000" class="next-head"/><link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" class="next-head"/><script class="next-head">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-93825702-2', 'auto');
        ga('send', 'pageview');
        </script><style id="__jsx-style-332883034">ul[data-jsx="332883034"]{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;list-style-type:none;padding:0}li[data-jsx="332883034"]{margin-right:1rem}li[data-jsx="332883034"]:last-child{margin-right:0}a[data-jsx="332883034"]{color:var(--text-color);font-size:.9rem;vertical-align:top}a[data-jsx="332883034"]:hover{color:var(--soft-color)}</style><style id="__jsx-style-2132458070">h1[data-jsx="2132458070"]{color:var(--text-color);font-weight:500;-webkit-letter-spacing:.5rem;-moz-letter-spacing:.5rem;-ms-letter-spacing:.5rem;letter-spacing:.5rem;-webkit-text-transform:uppercase;text-transform:uppercase}</style><style id="__jsx-style-330010697">header[data-jsx="330010697"]{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-position:50% 50%;background-size:cover;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:space-between;-webkit-justify-content:space-between;-ms-flex-pack:space-between;justify-content:space-between;margin-bottom:1rem;padding:1rem}.credit[data-jsx="330010697"]{color:var(--soft-color)}</style><style id="__jsx-style-1627630954">footer[data-jsx="1627630954"]{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;padding:1rem 0}.date[data-jsx="1627630954"]{margin-right:1rem}.views[data-jsx="1627630954"]{margin-left:auto}span[data-jsx="1627630954"]{color:var(--soft-color);display:block}</style><style id="__jsx-style-1936107962">article{line-height:1.7;margin:0 auto;max-width:768px;padding:0 1rem 0 1rem}article h1{margin-bottom:1rem}article h2,article h3{margin-top:2rem;margin-bottom:.5rem}article p,article pre,article img,article blockquote{margin-bottom:1.6rem}article a{-webkit-text-decoration:underline;text-decoration:underline}article a:hover{color:var(--soft-color)}article blockquote{border-left:1px solid var(--high-color);color:var(--text-color);padding-left:1rem}article pre{background-color:rgba(0, 0, 0, 0.05);padding:1rem;white-space:pre-wrap;word-wrap:break-word}article code{background-color:rgba(0, 0, 0, 0.05);padding:3px}article img{display:block;height:auto;width:100%}#disqus_thread{margin-top:2rem}</style><style id="__jsx-style-13140244585">*,*:before,*:after{box-sizing:border-box;margin:0}html,body{font-family:'Montserrat', sans-serif;font-size:1rem;height:100%;color:rgba(0, 0, 0, .8)}:root{--high-color:#000;--text-color:rgba(0, 0, 0, .8);--soft-color:rgba(0, 0, 0, .6)}h1{font-size:1.9rem}h2{font-size:1.6rem}h3{font-size:1.3rem}span,p,a,code,blockquote,pre{font-size:.9rem}a{color:var(--high-color);-webkit-text-decoration:none;text-decoration:none;-webkit-transition:all 0.2s ease;transition:all 0.2s ease}</style></head><body><div><div id="__next"><div data-reactroot="" data-reactid="1" data-react-checksum="1638951684"><div data-reactid="2"><!-- react-empty: 3 --><header style="background-image:url(https://images.unsplash.com/photo-1454991727061-be514eae86f7?&amp;w=1080&amp;h=720);height:60vh;" data-jsx="330010697" data-reactid="4"><nav data-jsx="332883034" data-reactid="5"><ul data-jsx="332883034" data-reactid="6"><li data-jsx="332883034" data-reactid="7"><a href="https://twitter.com/jlobitu" target="_black" data-jsx="332883034" data-reactid="8">TWITTER</a></li><li data-jsx="332883034" data-reactid="9"><a href="https://github.com/jlobos" target="_black" data-jsx="332883034" data-reactid="10">GITHUB</a></li><li data-jsx="332883034" data-reactid="11"><a href="mailto:jlobitu@gmail.com" target="_black" data-jsx="332883034" data-reactid="12">EMAIL</a></li></ul><!-- react-empty: 13 --></nav><div data-jsx="2132458070" data-reactid="14"><a href="/" data-jsx="2132458070" data-reactid="15"><h1 data-jsx="2132458070" data-reactid="16">JLOBOS</h1></a><!-- react-empty: 17 --></div><p class="credit" data-jsx="330010697" data-reactid="18">Photo by Thomas Kelley on Unsplash</p><!-- react-empty: 19 --></header><article data-reactid="20"><header data-reactid="21"><footer data-jsx="1627630954" data-reactid="22"><span class="date" data-jsx="1627630954" data-reactid="23">July 6, 2017</span><span data-jsx="1627630954" data-reactid="24"><!-- react-text: 25 -->3<!-- /react-text --><!-- react-text: 26 --> min read<!-- /react-text --></span><span class="views" data-jsx="1627630954" data-reactid="27"><!-- react-text: 28 -->257<!-- /react-text --><!-- react-text: 29 --> views<!-- /react-text --></span><!-- react-empty: 30 --></footer></header><div data-reactid="31"><html><head></head><body><div><h1>Deploy en Digitalocean con Node.js Nginx SSL y&#xA0;Docker</h1><p>En este art&#xED;culo explicar&#xE9; como montar una arquitectura de principio a fin con Node.js, Nginx como proxy y un certificado gratis SSL con Certbot todo esto manejando contenedores de Docker.</p><blockquote>Todo este procedimiento se realiz&#xF3; para levantar este blog, en la lectura aparecer&#xE1;n los diferentes repositorios.</blockquote><p>Para comenzar nos aseguramos de tener lo necesario, una cuenta en Digitalocean y un dominio.</p><blockquote>Puedes registrarte con este <a href="https://medium.com/r/?url=https%3A%2F%2Fm.do.co%2Fc%2Fc58082e089db" target="_blank">enlace</a> para que consigas USD $10 gratis, empezar&#xE1;s tu aventura con USD $15 que serian 3 meses del servicio b&#xE1;sico.</blockquote><blockquote>Comenzamos creamos un nuevo Droplet de Digitalocean, escogemos Ubuntu como distribuci&#xF3;n con la versi&#xF3;n por defecto, el tama&#xF1;o m&#xE1;s peque&#xF1;ito (ser&#xE1; suficiente), seleccionamos la regi&#xF3;n que m&#xE1;s nos acomode y agregamos nuestra llave SSH.</blockquote><pre># mostramos por pantalla nuestra llave p&#xFA;blica<br>cat ~/.ssh/id_rsa.pub</pre><blockquote>Si a&#xFA;n no dispone de una llave, puede crearla siguiendo esta guia de <a href="https://medium.com/r/?url=https%3A%2F%2Fhelp.github.com%2Farticles%2Fgenerating-a-new-ssh-key-and-adding-it-to-the-ssh-agent%2F" target="_blank">Github</a>.</blockquote><p>Con nuestro Droplet creado solo nos queda conectarnos, copiamos la direcci&#xF3;n ip y ingresamos como usuario <code>root</code>.</p><pre>ssh root@67.205.139.183</pre><h3>Docker</h3><p>Ya dentro de nuestra m&#xE1;quina en la nube, instalaremos Docker. Una forma r&#xE1;pida y f&#xE1;cil para tener la versi&#xF3;n m&#xE1;s reciente, es mediante:</p><pre># descargamos el script de instalaci&#xF3;n y lo ejecutamos<br>curl -sSL https://get.docker.com/ | sh<br># y comprobamos la versi&#xF3;n<br>docker version</pre><h3>Certbot</h3><p>Crearemos un certificado ssl (https) gratis y autom&#xE1;ticamente gracias a <a href="https://medium.com/r/?url=https%3A%2F%2Fcertbot.eff.org%2F" target="_blank">Let&#x2019;s Encrypt</a>.</p><pre># creamos un volumen para almacenar los certificados para luego compartirlos entre contenedores<br>docker volume create --name nginx-certs</pre><p>Ahora crearemos un contenedor con la <a href="https://medium.com/r/?url=https%3A%2F%2Fhub.docker.com%2Fr%2Fcertbot%2Fcertbot%2F" target="_blank">imagen oficial</a> de <code>cerbot</code>, este se conectara entre nuestra m&#xE1;quina y el proveedor del certificado para eso le indicamos los puertos 80 y 443 (no debe haber nada ocupando esos puertos), y guardar&#xE1; los certificados en el volumen de docker que acabamos de crear (<code>-v nginx-certs:/etc/letsencrypt</code>).</p><p>Debemos indicarle un correo (<code>--email</code>) y nuestros dominios separados por coma (<code>-d</code>).</p><blockquote>Solo se ejecutara y luego se eliminar&#xE1; el contenedor (<code><em>--rm</em></code>).</blockquote><pre>docker run -v nginx-certs:/etc/letsencrypt -p 80:80 -p 443:443 --rm certbot/certbot certonly --verbose --standalone --noninteractive --agree-tos --quiet --email=tu@gmail.com -d example.com,www.example.com</pre><p>Si quieres una versi&#xF3;n interactiva de <code>certbot</code> (te pedir&#xE1; los datos paso a paso):</p><pre>docker run -it -v nginx-certs:/etc/letsencrypt -p 80:80 -p 443:443 --rm certbot/certbot certonly --standalone</pre><p>Hay que tener en cuenta que el certificado por seguridad expira cada 90 d&#xED;as, para validarlo solo debemos hacer:</p><pre>docker run -v nginx-certs:/etc/letsencrypt --rm certbot/certbot renew</pre><p>Para hacer este proceso autom&#xE1;ticamente podemos hacer uso de <code>crontab</code> (herramienta para automatizar tareas).</p><pre># creamos un archivo temporal<br>crontab -l &gt; tempcron<br># agregamos el comando docker run con certbot para que se ejecute a las 1:00 los lunes<br>echo &#x201C;00 1 * * 1 docker run -v nginx-certs:/etc/letsencrypt --rm certbot/certbot renew&#x201D; &gt;&gt; tempcron<br># y reiniciamos nginx a las 1:30 los lunes<br>echo &#x201C;30 1 * * 1 docker restart nginx&#x201D; &gt;&gt; tempcron<br># guardamos y borramos el archivo temporal<br>crontab tempcron &amp;&amp; rm tempcron<br># mostramos c&#xF3;mo qued&#xF3; nuestra configuraci&#xF3;n<br>crontab -l</pre><h3>Node.js</h3><p>Para este ejemplo usaremos mi <a href="https://medium.com/r/?url=https%3A%2F%2Fgithub.com%2Fjlobos%2Fblog" target="_blank">blog</a>, que ya est&#xE1; en una imagen p&#xFA;blica en <a href="https://medium.com/r/?url=https%3A%2F%2Fhub.docker.com%2Fr%2Fjlobos%2Fblog%2F" target="_blank">Docker Hub</a>.</p><blockquote>Puedes ver la <a href="https://medium.com/r/?url=https%3A%2F%2Fnodejs.org%2Fen%2Fdocs%2Fguides%2Fnodejs-docker-webapp" target="_blank">guia oficial</a> para Dockerizar una Node.js app.</blockquote><pre># corremos el container<br>docker run -d --name blog jlobos/blog<br># vemos el estado del container<br>docker ps</pre><h3>Nginx</h3><p>Ya que tenemos los certificados listos, una app corriendo para ser redireccionada solo nos falta el container de Nginx con su respectiva configuraci&#xF3;n, tambi&#xE9;n usaremos las de mi <a href="https://medium.com/r/?url=https%3A%2F%2Fgithub.com%2Fjlobos%2Fblog-nginx%2Fblob%2Fmaster%2Fnginx.conf" target="_blank">blog</a>:</p><blockquote>En el <a href="https://medium.com/r/?url=https%3A%2F%2Fgithub.com%2Fjlobos%2Fblog-nginx%2Fblob%2Fmaster%2FDockerfile%23L6" target="_blank">Dockerfile</a> se agreg&#xF3; la creaci&#xF3;n de un certificado &#x2018;Diffie-Hellman&#x2019; de 2048 bits, para hacer m&#xE1;s segura nuestra configuraci&#xF3;n SSL.</blockquote><blockquote>Es importante adecuar la configuraci&#xF3;n de nginx a tu proyecto, puedes ver que existen par&#xE1;metros que se deben cambiar (<a href="https://medium.com/r/?url=https%3A%2F%2Fgithub.com%2Fjlobos%2Fblog-nginx%2Fblob%2Fmaster%2Fnginx.conf%23L12" target="_blank">nombre del contenedor que enlaza y el puerto</a>, <a href="https://medium.com/r/?url=https%3A%2F%2Fgithub.com%2Fjlobos%2Fblog-nginx%2Fblob%2Fmaster%2Fnginx.conf%23L24-L27" target="_blank">nombre del dominio</a>).</blockquote><pre># creamos la imagen (blog-nginx)<br>docker build -t blog-nginx https://github.com/jlobos/blog-nginx.git<br># corremos el container de nginx, lo enlazamos con nuestra app (blog) y le indicamos los puertos<br>docker run --name nginx -v nginx-certs:/etc/nginx/certs:ro -p 80:80 -p 443:443 -d --link blog blog-nginx</pre><p>Con todo esto ya tendr&#xED;amos una arquitectura completamente con contenedores Docker y una app escuchando en el puerto 80, ahora podemos <a href="https://medium.com/r/?url=https%3A%2F%2Fwww.ssllabs.com%2Fssltest%2Findex.html" target="_blank">comprobar nuestro certificado</a> y obtener un A+.</p></div></body></html></div></article><!-- react-empty: 32 --><!-- react-empty: 33 --></div></div></div><div id="__next-error"></div></div><div><script>
          __NEXT_DATA__ = {"props":{"post":{"value":{"id":"a64f463ec711","versionId":"30fa2e3e66f2","creatorId":"ff9c016747ea","homeCollectionId":"","title":"Deploy en Digitalocean con Node.js Nginx SSL y Docker","detectedLanguage":"es","latestVersion":"30fa2e3e66f2","latestPublishedVersion":"30fa2e3e66f2","hasUnpublishedEdits":false,"latestRev":71,"createdAt":1499317079637,"updatedAt":1499336292421,"acceptedAt":0,"firstPublishedAt":1499317219396,"latestPublishedAt":1499336291660,"vote":false,"experimentalCss":"","displayAuthor":"","content":{"subtitle":"En este artículo explicaré como montar una arquitectura de principio a fin con Node.js, Nginx como proxy y un certificado gratis SSL con…","bodyModel":{"paragraphs":[{"name":"45d7","type":3,"text":"Deploy en Digitalocean con Node.js Nginx SSL y Docker","markups":[]},{"name":"24f8","type":1,"text":"En este artículo explicaré como montar una arquitectura de principio a fin con Node.js, Nginx como proxy y un certificado gratis SSL con Certbot todo esto manejando contenedores de Docker.","markups":[]},{"name":"3e5e","type":6,"text":"Todo este procedimiento se realizó para levantar este blog, en la lectura aparecerán los diferentes repositorios.","markups":[]},{"name":"4c45","type":1,"text":"Para comenzar nos aseguramos de tener lo necesario, una cuenta en Digitalocean y un dominio.","markups":[]},{"name":"46de","type":6,"text":"Puedes registrarte con este enlace para que consigas USD $10 gratis, empezarás tu aventura con USD $15 que serian 3 meses del servicio básico.","markups":[{"type":3,"start":28,"end":34,"href":"https://m.do.co/c/c58082e089db","title":"","rel":"noopener","anchorType":0}]},{"name":"2686","type":6,"text":"Comenzamos creamos un nuevo Droplet de Digitalocean, escogemos Ubuntu como distribución con la versión por defecto, el tamaño más pequeñito (será suficiente), seleccionamos la región que más nos acomode y agregamos nuestra llave SSH.","markups":[]},{"name":"7f76","type":8,"text":"# mostramos por pantalla nuestra llave pública\ncat ~/.ssh/id_rsa.pub","markups":[]},{"name":"627a","type":6,"text":"Si aún no dispone de una llave, puede crearla siguiendo esta guia de Github.","markups":[{"type":3,"start":69,"end":75,"href":"https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/","title":"","rel":"noopener","anchorType":0}]},{"name":"119d","type":1,"text":"Con nuestro Droplet creado solo nos queda conectarnos, copiamos la dirección ip y ingresamos como usuario root.","markups":[{"type":10,"start":106,"end":110}]},{"name":"cc9d","type":8,"text":"ssh root@67.205.139.183","markups":[]},{"name":"4327","type":3,"text":"Docker","markups":[]},{"name":"eeaa","type":1,"text":"Ya dentro de nuestra máquina en la nube, instalaremos Docker. Una forma rápida y fácil para tener la versión más reciente, es mediante:","markups":[]},{"name":"4562","type":8,"text":"# descargamos el script de instalación y lo ejecutamos\ncurl -sSL https://get.docker.com/ | sh\n# y comprobamos la versión\ndocker version","markups":[]},{"name":"14a7","type":3,"text":"Certbot","markups":[]},{"name":"4b0f","type":1,"text":"Crearemos un certificado ssl (https) gratis y automáticamente gracias a Let’s Encrypt.","markups":[{"type":3,"start":72,"end":85,"href":"https://certbot.eff.org/","title":"","rel":"noopener","anchorType":0}]},{"name":"b21f","type":8,"text":"# creamos un volumen para almacenar los certificados para luego compartirlos entre contenedores\ndocker volume create --name nginx-certs","markups":[]},{"name":"1af0","type":1,"text":"Ahora crearemos un contenedor con la imagen oficial de cerbot, este se conectara entre nuestra máquina y el proveedor del certificado para eso le indicamos los puertos 80 y 443 (no debe haber nada ocupando esos puertos), y guardará los certificados en el volumen de docker que acabamos de crear (-v nginx-certs:/etc/letsencrypt).","markups":[{"type":10,"start":55,"end":61},{"type":10,"start":296,"end":327},{"type":3,"start":37,"end":51,"href":"https://hub.docker.com/r/certbot/certbot/","title":"","rel":"noopener","anchorType":0}]},{"name":"cca8","type":1,"text":"Debemos indicarle un correo (--email) y nuestros dominios separados por coma (-d).","markups":[{"type":10,"start":29,"end":36},{"type":10,"start":78,"end":80}]},{"name":"ee10","type":6,"text":"Solo se ejecutara y luego se eliminará el contenedor (--rm).","markups":[{"type":10,"start":54,"end":58},{"type":2,"start":54,"end":58}]},{"name":"ef2a","type":8,"text":"docker run -v nginx-certs:/etc/letsencrypt -p 80:80 -p 443:443 --rm certbot/certbot certonly --verbose --standalone --noninteractive --agree-tos --quiet --email=tu@gmail.com -d example.com,www.example.com","markups":[]},{"name":"0792","type":1,"text":"Si quieres una versión interactiva de certbot (te pedirá los datos paso a paso):","markups":[{"type":10,"start":38,"end":45}]},{"name":"612b","type":8,"text":"docker run -it -v nginx-certs:/etc/letsencrypt -p 80:80 -p 443:443 --rm certbot/certbot certonly --standalone","markups":[]},{"name":"a25c","type":1,"text":"Hay que tener en cuenta que el certificado por seguridad expira cada 90 días, para validarlo solo debemos hacer:","markups":[]},{"name":"6132","type":8,"text":"docker run -v nginx-certs:/etc/letsencrypt --rm certbot/certbot renew","markups":[]},{"name":"a494","type":1,"text":"Para hacer este proceso automáticamente podemos hacer uso de crontab (herramienta para automatizar tareas).","markups":[{"type":10,"start":61,"end":68}]},{"name":"483d","type":8,"text":"# creamos un archivo temporal\ncrontab -l \u003e tempcron\n# agregamos el comando docker run con certbot para que se ejecute a las 1:00 los lunes\necho “00 1 * * 1 docker run -v nginx-certs:/etc/letsencrypt --rm certbot/certbot renew” \u003e\u003e tempcron\n# y reiniciamos nginx a las 1:30 los lunes\necho “30 1 * * 1 docker restart nginx” \u003e\u003e tempcron\n# guardamos y borramos el archivo temporal\ncrontab tempcron \u0026\u0026 rm tempcron\n# mostramos cómo quedó nuestra configuración\ncrontab -l","markups":[]},{"name":"96e9","type":3,"text":"Node.js","markups":[]},{"name":"c222","type":1,"text":"Para este ejemplo usaremos mi blog, que ya está en una imagen pública en Docker Hub.","markups":[{"type":3,"start":30,"end":34,"href":"https://github.com/jlobos/blog","title":"","rel":"noopener","anchorType":0},{"type":3,"start":73,"end":83,"href":"https://hub.docker.com/r/jlobos/blog/","title":"","rel":"noopener","anchorType":0}]},{"name":"0702","type":6,"text":"Puedes ver la guia oficial para Dockerizar una Node.js app.","markups":[{"type":3,"start":14,"end":26,"href":"https://nodejs.org/en/docs/guides/nodejs-docker-webapp","title":"","rel":"noopener","anchorType":0}]},{"name":"deb7","type":8,"text":"# corremos el container\ndocker run -d --name blog jlobos/blog\n# vemos el estado del container\ndocker ps","markups":[]},{"name":"eef7","type":3,"text":"Nginx","markups":[]},{"name":"c422","type":1,"text":"Ya que tenemos los certificados listos, una app corriendo para ser redireccionada solo nos falta el container de Nginx con su respectiva configuración, también usaremos las de mi blog:","markups":[{"type":3,"start":179,"end":183,"href":"https://github.com/jlobos/blog-nginx/blob/master/nginx.conf","title":"","rel":"noopener","anchorType":0}]},{"name":"bae9","type":6,"text":"En el Dockerfile se agregó la creación de un certificado ‘Diffie-Hellman’ de 2048 bits, para hacer más segura nuestra configuración SSL.","markups":[{"type":3,"start":6,"end":16,"href":"https://github.com/jlobos/blog-nginx/blob/master/Dockerfile#L6","title":"","rel":"noopener","anchorType":0}]},{"name":"895f","type":6,"text":"Es importante adecuar la configuración de nginx a tu proyecto, puedes ver que existen parámetros que se deben cambiar (nombre del contenedor que enlaza y el puerto, nombre del dominio).","markups":[{"type":3,"start":119,"end":163,"href":"https://github.com/jlobos/blog-nginx/blob/master/nginx.conf#L12","title":"","rel":"noopener","anchorType":0},{"type":3,"start":165,"end":183,"href":"https://github.com/jlobos/blog-nginx/blob/master/nginx.conf#L24-L27","title":"","rel":"noopener","anchorType":0}]},{"name":"5d57","type":8,"text":"# creamos la imagen (blog-nginx)\ndocker build -t blog-nginx https://github.com/jlobos/blog-nginx.git\n# corremos el container de nginx, lo enlazamos con nuestra app (blog) y le indicamos los puertos\ndocker run --name nginx -v nginx-certs:/etc/nginx/certs:ro -p 80:80 -p 443:443 -d --link blog blog-nginx","markups":[]},{"name":"9ffa","type":1,"text":"Con todo esto ya tendríamos una arquitectura completamente con contenedores Docker y una app escuchando en el puerto 80, ahora podemos comprobar nuestro certificado y obtener un A+.","markups":[{"type":3,"start":135,"end":164,"href":"https://www.ssllabs.com/ssltest/index.html","title":"","rel":"noopener","anchorType":0}]},{"name":"4e9e","type":8,"text":"{\n  \"image\": {\n    \"url\": \"https://images.unsplash.com/photo-1454991727061-be514eae86f7?\u0026w=1080\u0026h=720\",\n    \"credit\": \"Photo by Thomas Kelley on Unsplash\"\n  }\n}","markups":[]}],"sections":[{"name":"5b45","startIndex":0}]},"postDisplay":{"coverless":true}},"virtuals":{"allowNotes":true,"previewImage":{"imageId":"","filter":"","backgroundSize":"","originalWidth":0,"originalHeight":0,"strategy":"resample","height":0,"width":0},"wordCount":715,"imageCount":0,"readingTime":2.69811320754717,"subtitle":"En este artículo explicaré como montar una arquitectura de principio a fin con Node.js, Nginx como proxy y un certificado gratis SSL con…","userPostRelation":{"userId":"ff9c016747ea","postId":"a64f463ec711","readAt":1499336291892,"readLaterAddedAt":0,"votedAt":0,"collaboratorAddedAt":0,"notesAddedAt":0,"subscribedAt":0,"lastReadSectionName":"5b45","lastReadVersionId":"ee6afa70d02f","lastReadAt":1499336064308,"lastReadParagraphName":"2686","lastReadPercentage":0.13,"viewedAt":1499336299293,"presentedCountInResponseManagement":0,"clapCount":0,"seriesUpdateNotifsOptedInAt":0,"queuedAt":0,"seriesFirstViewedAt":0,"presentedCountInStream":5,"seriesLastViewedAt":0,"audioProgressSec":0},"usersBySocialRecommends":[],"recommends":0,"isBookmarked":false,"tags":[{"slug":"deploy","name":"Deploy","postCount":79,"virtuals":{"isFollowing":false},"metadata":{"followerCount":5,"postCount":79,"coverImage":{"id":"1*WTm8cPVgLT070SU5CtXDHg.jpeg","originalWidth":3264,"originalHeight":2448}},"type":"Tag"},{"slug":"digitalocean","name":"Digitalocean","postCount":265,"virtuals":{"isFollowing":false},"metadata":{"followerCount":63,"postCount":265,"coverImage":{"id":"1*dI79AjwHJSs-eC6dZB77Uw.png","originalWidth":648,"originalHeight":295}},"type":"Tag"},{"slug":"nodejs","name":"Nodejs","postCount":6586,"virtuals":{"isFollowing":false},"metadata":{"followerCount":10845,"postCount":6586,"coverImage":{"id":"1*6wZYofh0czXf3SO8Ubw2xg.png","originalWidth":1400,"originalHeight":933}},"type":"Tag"},{"slug":"docker","name":"Docker","postCount":5064,"virtuals":{"isFollowing":false},"metadata":{"followerCount":4203,"postCount":5064,"coverImage":{"id":"0*7pkTcE_FWnGtzktZ.jpeg","originalWidth":600,"originalHeight":337}},"type":"Tag"},{"slug":"ssl","name":"Ssl","postCount":1017,"virtuals":{"isFollowing":false},"metadata":{"followerCount":56,"postCount":1017,"coverImage":{"id":"1*DY1POfSf1tnvimNOH9pz6A.png","originalWidth":1160,"originalHeight":1734}},"type":"Tag"}],"socialRecommendsCount":0,"responsesCreatedCount":0,"links":{"entries":[{"url":"https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/","alts":[],"httpStatus":200},{"url":"https://github.com/jlobos/blog-nginx/blob/master/nginx.conf#L24-L27","alts":[],"httpStatus":200},{"url":"https://nodejs.org/en/docs/guides/nodejs-docker-webapp","alts":[],"httpStatus":200},{"url":"https://github.com/jlobos/blog","alts":[],"httpStatus":200},{"url":"https://github.com/jlobos/blog-nginx/blob/master/nginx.conf","alts":[],"httpStatus":200},{"url":"https://github.com/jlobos/blog-nginx/blob/master/nginx.conf#L12","alts":[],"httpStatus":200},{"url":"https://hub.docker.com/r/jlobos/blog/","alts":[],"httpStatus":200},{"url":"https://m.do.co/c/c58082e089db","alts":[],"httpStatus":200},{"url":"https://github.com/jlobos/blog-nginx/blob/master/Dockerfile#L6","alts":[],"httpStatus":200},{"url":"https://certbot.eff.org/","alts":[],"httpStatus":200},{"url":"https://hub.docker.com/r/certbot/certbot/","alts":[],"httpStatus":200},{"url":"https://www.ssllabs.com/ssltest/index.html","alts":[],"httpStatus":200}],"version":"0.3","generatedAt":1499336292589},"isLockedPreviewOnly":false,"takeoverId":"","metaDescription":"","totalClapCount":0,"sectionCount":1},"coverless":true,"slug":"deploy-en-digitalocean-con-node-js-nginx-ssl-y-docker","translationSourcePostId":"","translationSourceCreatorId":"","isApprovedTranslation":false,"inResponseToPostId":"","inResponseToRemovedAt":0,"isTitleSynthesized":true,"allowResponses":true,"importedUrl":"","importedPublishedAt":0,"visibility":1,"uniqueSlug":"deploy-en-digitalocean-con-node-js-nginx-ssl-y-docker-a64f463ec711","previewContent":{"bodyModel":{"paragraphs":[{"name":"45d7","type":3,"text":"Deploy en Digitalocean con Node.js Nginx SSL y Docker","markups":[],"alignment":1},{"name":"24f8","type":1,"text":"En este artículo explicaré como montar una arquitectura de principio a fin con Node.js, Nginx como proxy y un certificado gratis SSL con Certbot todo esto manejando contenedores de Docker.","markups":[],"alignment":1},{"name":"3e5e","type":6,"text":"Todo este…","markups":[],"alignment":1}],"sections":[{"startIndex":0}]},"isFullContent":false},"license":0,"inResponseToMediaResourceId":"","canonicalUrl":"https://medium.com/@jlobos/deploy-en-digitalocean-con-node-js-nginx-ssl-y-docker-a64f463ec711","approvedHomeCollectionId":"","newsletterId":"","webCanonicalUrl":"https://medium.com/@jlobos/deploy-en-digitalocean-con-node-js-nginx-ssl-y-docker-a64f463ec711","mediumUrl":"https://medium.com/@jlobos/deploy-en-digitalocean-con-node-js-nginx-ssl-y-docker-a64f463ec711","migrationId":"","notifyFollowers":true,"notifyTwitter":false,"isSponsored":false,"isRequestToPubDisabled":false,"notifyFacebook":false,"responseHiddenOnParentPostAt":0,"isSeries":false,"isSubscriptionLocked":false,"seriesLastAppendedAt":0,"audioVersionDurationSec":0,"sequenceId":"","isNsfw":false,"premiumTier":1,"type":"Post","views":257},"mentionedUsers":[],"collaborators":[],"membershipPlans":[],"collectionUserRelations":[],"mode":"canEdit","references":{"User":{"ff9c016747ea":{"userId":"ff9c016747ea","name":"Jesus Lobos","username":"jlobos","createdAt":1459503817004,"lastPostCreatedAt":1499317079637,"imageId":"1*rRlettGDF0FAw4ayKZmUzw.jpeg","backgroundImageId":"","bio":"","twitterScreenName":"jlobitu","socialStats":{"userId":"ff9c016747ea","usersFollowedCount":17,"usersFollowedByCount":5,"type":"SocialStats"},"social":{"userId":"ff9c016747ea","targetUserId":"ff9c016747ea","type":"Social"},"facebookAccountId":"966606470080429","allowNotes":1,"type":"User"}},"Social":{"ff9c016747ea":{"userId":"ff9c016747ea","targetUserId":"ff9c016747ea","type":"Social"}},"SocialStats":{"ff9c016747ea":{"userId":"ff9c016747ea","usersFollowedCount":17,"usersFollowedByCount":5,"type":"SocialStats"}}},"injected":{"meta":{"image":{"url":"https://images.unsplash.com/photo-1454991727061-be514eae86f7?\u0026w=1080\u0026h=720","credit":"Photo by Thomas Kelley on Unsplash"}},"html":"\u003chtml\u003e\u003chead\u003e\u003c/head\u003e\u003cbody\u003e\u003cdiv\u003e\u003ch1\u003eDeploy en Digitalocean con Node.js Nginx SSL y\u0026#xA0;Docker\u003c/h1\u003e\u003cp\u003eEn este art\u0026#xED;culo explicar\u0026#xE9; como montar una arquitectura de principio a fin con Node.js, Nginx como proxy y un certificado gratis SSL con Certbot todo esto manejando contenedores de Docker.\u003c/p\u003e\u003cblockquote\u003eTodo este procedimiento se realiz\u0026#xF3; para levantar este blog, en la lectura aparecer\u0026#xE1;n los diferentes repositorios.\u003c/blockquote\u003e\u003cp\u003ePara comenzar nos aseguramos de tener lo necesario, una cuenta en Digitalocean y un dominio.\u003c/p\u003e\u003cblockquote\u003ePuedes registrarte con este \u003ca href=\"https://medium.com/r/?url=https%3A%2F%2Fm.do.co%2Fc%2Fc58082e089db\" target=\"_blank\"\u003eenlace\u003c/a\u003e para que consigas USD $10 gratis, empezar\u0026#xE1;s tu aventura con USD $15 que serian 3 meses del servicio b\u0026#xE1;sico.\u003c/blockquote\u003e\u003cblockquote\u003eComenzamos creamos un nuevo Droplet de Digitalocean, escogemos Ubuntu como distribuci\u0026#xF3;n con la versi\u0026#xF3;n por defecto, el tama\u0026#xF1;o m\u0026#xE1;s peque\u0026#xF1;ito (ser\u0026#xE1; suficiente), seleccionamos la regi\u0026#xF3;n que m\u0026#xE1;s nos acomode y agregamos nuestra llave SSH.\u003c/blockquote\u003e\u003cpre\u003e# mostramos por pantalla nuestra llave p\u0026#xFA;blica\u003cbr\u003ecat ~/.ssh/id_rsa.pub\u003c/pre\u003e\u003cblockquote\u003eSi a\u0026#xFA;n no dispone de una llave, puede crearla siguiendo esta guia de \u003ca href=\"https://medium.com/r/?url=https%3A%2F%2Fhelp.github.com%2Farticles%2Fgenerating-a-new-ssh-key-and-adding-it-to-the-ssh-agent%2F\" target=\"_blank\"\u003eGithub\u003c/a\u003e.\u003c/blockquote\u003e\u003cp\u003eCon nuestro Droplet creado solo nos queda conectarnos, copiamos la direcci\u0026#xF3;n ip y ingresamos como usuario \u003ccode\u003eroot\u003c/code\u003e.\u003c/p\u003e\u003cpre\u003essh root@67.205.139.183\u003c/pre\u003e\u003ch3\u003eDocker\u003c/h3\u003e\u003cp\u003eYa dentro de nuestra m\u0026#xE1;quina en la nube, instalaremos Docker. Una forma r\u0026#xE1;pida y f\u0026#xE1;cil para tener la versi\u0026#xF3;n m\u0026#xE1;s reciente, es mediante:\u003c/p\u003e\u003cpre\u003e# descargamos el script de instalaci\u0026#xF3;n y lo ejecutamos\u003cbr\u003ecurl -sSL https://get.docker.com/ | sh\u003cbr\u003e# y comprobamos la versi\u0026#xF3;n\u003cbr\u003edocker version\u003c/pre\u003e\u003ch3\u003eCertbot\u003c/h3\u003e\u003cp\u003eCrearemos un certificado ssl (https) gratis y autom\u0026#xE1;ticamente gracias a \u003ca href=\"https://medium.com/r/?url=https%3A%2F%2Fcertbot.eff.org%2F\" target=\"_blank\"\u003eLet\u0026#x2019;s Encrypt\u003c/a\u003e.\u003c/p\u003e\u003cpre\u003e# creamos un volumen para almacenar los certificados para luego compartirlos entre contenedores\u003cbr\u003edocker volume create --name nginx-certs\u003c/pre\u003e\u003cp\u003eAhora crearemos un contenedor con la \u003ca href=\"https://medium.com/r/?url=https%3A%2F%2Fhub.docker.com%2Fr%2Fcertbot%2Fcertbot%2F\" target=\"_blank\"\u003eimagen oficial\u003c/a\u003e de \u003ccode\u003ecerbot\u003c/code\u003e, este se conectara entre nuestra m\u0026#xE1;quina y el proveedor del certificado para eso le indicamos los puertos 80 y 443 (no debe haber nada ocupando esos puertos), y guardar\u0026#xE1; los certificados en el volumen de docker que acabamos de crear (\u003ccode\u003e-v nginx-certs:/etc/letsencrypt\u003c/code\u003e).\u003c/p\u003e\u003cp\u003eDebemos indicarle un correo (\u003ccode\u003e--email\u003c/code\u003e) y nuestros dominios separados por coma (\u003ccode\u003e-d\u003c/code\u003e).\u003c/p\u003e\u003cblockquote\u003eSolo se ejecutara y luego se eliminar\u0026#xE1; el contenedor (\u003ccode\u003e\u003cem\u003e--rm\u003c/em\u003e\u003c/code\u003e).\u003c/blockquote\u003e\u003cpre\u003edocker run -v nginx-certs:/etc/letsencrypt -p 80:80 -p 443:443 --rm certbot/certbot certonly --verbose --standalone --noninteractive --agree-tos --quiet --email=tu@gmail.com -d example.com,www.example.com\u003c/pre\u003e\u003cp\u003eSi quieres una versi\u0026#xF3;n interactiva de \u003ccode\u003ecertbot\u003c/code\u003e (te pedir\u0026#xE1; los datos paso a paso):\u003c/p\u003e\u003cpre\u003edocker run -it -v nginx-certs:/etc/letsencrypt -p 80:80 -p 443:443 --rm certbot/certbot certonly --standalone\u003c/pre\u003e\u003cp\u003eHay que tener en cuenta que el certificado por seguridad expira cada 90 d\u0026#xED;as, para validarlo solo debemos hacer:\u003c/p\u003e\u003cpre\u003edocker run -v nginx-certs:/etc/letsencrypt --rm certbot/certbot renew\u003c/pre\u003e\u003cp\u003ePara hacer este proceso autom\u0026#xE1;ticamente podemos hacer uso de \u003ccode\u003ecrontab\u003c/code\u003e (herramienta para automatizar tareas).\u003c/p\u003e\u003cpre\u003e# creamos un archivo temporal\u003cbr\u003ecrontab -l \u0026gt; tempcron\u003cbr\u003e# agregamos el comando docker run con certbot para que se ejecute a las 1:00 los lunes\u003cbr\u003eecho \u0026#x201C;00 1 * * 1 docker run -v nginx-certs:/etc/letsencrypt --rm certbot/certbot renew\u0026#x201D; \u0026gt;\u0026gt; tempcron\u003cbr\u003e# y reiniciamos nginx a las 1:30 los lunes\u003cbr\u003eecho \u0026#x201C;30 1 * * 1 docker restart nginx\u0026#x201D; \u0026gt;\u0026gt; tempcron\u003cbr\u003e# guardamos y borramos el archivo temporal\u003cbr\u003ecrontab tempcron \u0026amp;\u0026amp; rm tempcron\u003cbr\u003e# mostramos c\u0026#xF3;mo qued\u0026#xF3; nuestra configuraci\u0026#xF3;n\u003cbr\u003ecrontab -l\u003c/pre\u003e\u003ch3\u003eNode.js\u003c/h3\u003e\u003cp\u003ePara este ejemplo usaremos mi \u003ca href=\"https://medium.com/r/?url=https%3A%2F%2Fgithub.com%2Fjlobos%2Fblog\" target=\"_blank\"\u003eblog\u003c/a\u003e, que ya est\u0026#xE1; en una imagen p\u0026#xFA;blica en \u003ca href=\"https://medium.com/r/?url=https%3A%2F%2Fhub.docker.com%2Fr%2Fjlobos%2Fblog%2F\" target=\"_blank\"\u003eDocker Hub\u003c/a\u003e.\u003c/p\u003e\u003cblockquote\u003ePuedes ver la \u003ca href=\"https://medium.com/r/?url=https%3A%2F%2Fnodejs.org%2Fen%2Fdocs%2Fguides%2Fnodejs-docker-webapp\" target=\"_blank\"\u003eguia oficial\u003c/a\u003e para Dockerizar una Node.js app.\u003c/blockquote\u003e\u003cpre\u003e# corremos el container\u003cbr\u003edocker run -d --name blog jlobos/blog\u003cbr\u003e# vemos el estado del container\u003cbr\u003edocker ps\u003c/pre\u003e\u003ch3\u003eNginx\u003c/h3\u003e\u003cp\u003eYa que tenemos los certificados listos, una app corriendo para ser redireccionada solo nos falta el container de Nginx con su respectiva configuraci\u0026#xF3;n, tambi\u0026#xE9;n usaremos las de mi \u003ca href=\"https://medium.com/r/?url=https%3A%2F%2Fgithub.com%2Fjlobos%2Fblog-nginx%2Fblob%2Fmaster%2Fnginx.conf\" target=\"_blank\"\u003eblog\u003c/a\u003e:\u003c/p\u003e\u003cblockquote\u003eEn el \u003ca href=\"https://medium.com/r/?url=https%3A%2F%2Fgithub.com%2Fjlobos%2Fblog-nginx%2Fblob%2Fmaster%2FDockerfile%23L6\" target=\"_blank\"\u003eDockerfile\u003c/a\u003e se agreg\u0026#xF3; la creaci\u0026#xF3;n de un certificado \u0026#x2018;Diffie-Hellman\u0026#x2019; de 2048 bits, para hacer m\u0026#xE1;s segura nuestra configuraci\u0026#xF3;n SSL.\u003c/blockquote\u003e\u003cblockquote\u003eEs importante adecuar la configuraci\u0026#xF3;n de nginx a tu proyecto, puedes ver que existen par\u0026#xE1;metros que se deben cambiar (\u003ca href=\"https://medium.com/r/?url=https%3A%2F%2Fgithub.com%2Fjlobos%2Fblog-nginx%2Fblob%2Fmaster%2Fnginx.conf%23L12\" target=\"_blank\"\u003enombre del contenedor que enlaza y el puerto\u003c/a\u003e, \u003ca href=\"https://medium.com/r/?url=https%3A%2F%2Fgithub.com%2Fjlobos%2Fblog-nginx%2Fblob%2Fmaster%2Fnginx.conf%23L24-L27\" target=\"_blank\"\u003enombre del dominio\u003c/a\u003e).\u003c/blockquote\u003e\u003cpre\u003e# creamos la imagen (blog-nginx)\u003cbr\u003edocker build -t blog-nginx https://github.com/jlobos/blog-nginx.git\u003cbr\u003e# corremos el container de nginx, lo enlazamos con nuestra app (blog) y le indicamos los puertos\u003cbr\u003edocker run --name nginx -v nginx-certs:/etc/nginx/certs:ro -p 80:80 -p 443:443 -d --link blog blog-nginx\u003c/pre\u003e\u003cp\u003eCon todo esto ya tendr\u0026#xED;amos una arquitectura completamente con contenedores Docker y una app escuchando en el puerto 80, ahora podemos \u003ca href=\"https://medium.com/r/?url=https%3A%2F%2Fwww.ssllabs.com%2Fssltest%2Findex.html\" target=\"_blank\"\u003ecomprobar nuestro certificado\u003c/a\u003e y obtener un A+.\u003c/p\u003e\u003c/div\u003e\u003c/body\u003e\u003c/html\u003e"}}},"pathname":"/post","query":{"slug":"deploy-en-digitalocean-con-node-js-nginx-ssl-y-docker"},"buildId":"def0ce2c-a931-474c-9741-365499518ee9","buildStats":{"app.js":{"hash":"33a7e45548f8fb8000dd8f014de5fbfb"}},"assetPrefix":"","nextExport":true,"err":null,"chunks":[]}
          module={}
          __NEXT_LOADED_PAGES__ = []
          __NEXT_LOADED_CHUNKS__ = []

          __NEXT_REGISTER_PAGE = function (route, fn) {
            __NEXT_LOADED_PAGES__.push({ route: route, fn: fn })
          }

          __NEXT_REGISTER_CHUNK = function (chunkName, fn) {
            __NEXT_LOADED_CHUNKS__.push({ chunkName: chunkName, fn: fn })
          }
        </script><script async="" id="__NEXT_PAGE__/post" type="text/javascript" src="/_next/def0ce2c-a931-474c-9741-365499518ee9/page/post/index.js"></script><script async="" id="__NEXT_PAGE__/_error" type="text/javascript" src="/_next/def0ce2c-a931-474c-9741-365499518ee9/page/_error/index.js"></script><div></div><script type="text/javascript" src="/_next/33a7e45548f8fb8000dd8f014de5fbfb/app.js" async=""></script></div></body></html>